% https://tex.stackexchange.com/questions/345898/lualatex-0-95-0-tl-2016-has-problem-with-crop-and-microtype-packages-being-tog#345906
% because of the crop pkg
\RequirePackage{luatex85}

\documentclass[11pt,a5paper,twoside]{article}

\directlua{dofile("DetectUnderfull.lua")}


\newif\ifplastex
\plastexfalse

% used inside TikZ, thus must be accessible to PlasTeX as well
\usepackage[dvipsnames]{xcolor}

\ifplastex
	\def\lessstressLogo{\texttt{lessstress.cz}}
\else
	\usepackage{enumitem}
	\usepackage{euler}
	\usepackage{fontspec}
	\defaultfontfeatures{Ligatures=TeX} % Mapping=tex-text}
	\setmainfont[
		%BoldFont={CMU Serif Bold Extended Roman}
		BoldFont={CMU Sans Serif Bold},
		BoldFeatures={SmallCapsFont=CMU Serif Bold Extended Roman,SmallCapsFeatures={Letters=SmallCaps}},
		%BoldFont={Iwona Heavy}
	]{CMU Concrete}
	\bibliographystyle{plain}
	\usepackage[left=2cm,right=1.5cm,top=2.5cm,bottom=2.5cm,headheight=14pt]{geometry}

	\usepackage{polyglossia}
	\setdefaultlanguage{czech}
	\usepackage{booktabs}

	\setlist[description]{style=unboxed}
	\usepackage{luavlna}
	\usepackage{tabularray}
	\usepackage{adjustbox}
	\usepackage[tracking,expansion,protrusion]{microtype}
	\lefthyphenmin=2
	\righthyphenmin=2
	\usepackage{verse}

	\usepackage[normalem]{ulem}
	\setlength{\ULdepth}{.7mm}
	\def\lessstressLogo{\href{https://lessstress.cz}{\textsf{\textbf{le\uline{\uline{\uline{s}s}s}tre\uline{\uline{s}s}.cz\uline{\hphantom{s}}}}}}

	\usepackage[norule,hang,stable]{footmisc}
	\footnotemargin=1em

\fi
% \usepackage{mdwlist}
%\usepackage[colorlinks=false,allbordercolors=white]{hyperref}
\usepackage{hyperref}
% allow linebreak in description list title




\ifplastex
	\def\Blank#1{. . . . . . . . . . .}
\else
	% https://tex.stackexchange.com/a/481045/6758
	\usepackage{forloop}
	\newcounter{loopcntr}
	\newcommand{\rpt}[2][1]{\forloop{loopcntr}{0}{\value{loopcntr}<#1}{#2}}
	\def\myDottedLine{\noindent\vbox spread 1.5ex {}\null\xleaders\hbox to 1em {\hss {\small.} \hss}\hfill \null}%
	\def\Blank#1{%
		\rpt[\numexpr#1-1\relax]{\myDottedLine\newline}\myDottedLine%
	}
	% \def\blank#1{{\setbox0\hbox{#1}\hbox to\wd0{\dotfill}}}

	\usepackage{titlesec}
	\titleformat{\section}[frame]{\Large\bfseries}{\filright\enspace\thesection. setkání\enspace}{1em}{\Large\scshape\bfseries}
	%\titleformat{\section}{\Large\bfseries}{\filright\enspace\thesection. setkání\enspace\\}{0em}{\Large\scshape\bfseries}
\fi



\usepackage{tikz}
\usetikzlibrary{
	matrix,fit,shapes.callouts,shapes.arrows,shapes.misc,positioning,decorations.pathmorphing,arrows.meta,fpu,shapes.multipart,mindmap,arrows
}

% https://tex.stackexchange.com/a/72793
\tikzset{
	outlined arrow/.style args={#1 colored by #2 and #3}{		
		-latex,
		line width=#1,#2,
		postaction={draw,-latex,#3,line width=(#1)/3,shorten <=(#1)/4,shorten >=4.5*(#1)/3}
	}
}

\tikzset{
	% custom asymetric columnns
	left column/.style args={below #1}{at=(#1.south),anchor=north east,shift=({-.5em,-1em})},
	right column/.style args={below #1}{at=(#1.south),anchor=north west,shift=({.5em,-1em})},
	narrower left column/.style args={below #1}{at=(#1.south),anchor=north east,shift=({-.5em-.15\linewidth,-1em})},
	wider right column/.style args={below #1}{at=(#1.south),anchor=north west,shift=({.5em-.15\linewidth,-1em})},
	% custom styles
	thought/.style={dashed,rounded corners,font=\itshape},
	action/.style={solid,sharp corners},
	% FIXME: why not 2\pgfkeysvalueof ??
	wider sober/.style={
		fill=blue!10,align=justify,dotted,rectangle split,rectangle split parts=2,sharp corners,
		text width=.65*(\linewidth-1em)-1*\pgfkeysvalueof{/pgf/inner xsep}-2*\pgflinewidth
	},
	sober/.style={fill=blue!10,align=justify,dotted,rectangle split,rectangle split parts=2,sharp corners},
	mindful/.style={fill=blue!10,align=center,dotted},
	narrower autopilot/.style={
		fill=red!10,
		text width=.35*(\linewidth-1em)-1*\pgfkeysvalueof{/pgf/inner xsep}-2*\pgflinewidth
	},
	autopilot/.style={fill=red!10,dashed},
	sober arrow/.style={outlined arrow={.5mm colored by black and blue!40}},
	wide sober arrow/.style={outlined arrow={1mm colored by black and blue!40}},
	autopilot arrow/.style={outlined arrow={.5mm colored by black and red!40}},
	wide autopilot arrow/.style={outlined arrow={1mm colored by black and red!40}},
}

\def\soberName#1{\textbf{#1} \nodepart{two} }

\def\mbrpset#1{\pgfkeys{/mbrp/.cd,#1}}
\pgfkeys{/mbrp/.is family,/mbrp,
	title1/.initial=\undefined,
	title2/.initial=\undefined,
	autopilot/.store in=\mbrpAutopilot,
	brzda B/.initial={Zastavte se a vyskočte z autopilota.},
	brzda R/.store in=\mbrpBrzdaR,
	brzda R/.initial=\undefined,
	brzda Z/.initial={Několikrát se pomalu a pozorně nadýchěte a vydýchněte. Pozornost zaměřte na dech.},
	brzda D/.initial={Rozšiřte znovu svou pozornost na to, jak se cítíte. Nakolik to jde, zkuste to udělat s postojem otevřenosti a přijetí.},
	brzda A/.store in=\mbrpBrzdaA,
	brzda A/.initial=\undefined,
}

\newlist{iitemize}{itemize}{1}
\setlist[iitemize]{label=\circ,noitemsep,nosep,leftmargin=*}

\def\toSelf#1{\emph{„#1“}}
\def\itemName#1{\item \textbf{#1} }


\newcommand{\soberSpace}[1]{
	\begin{adjustbox}{width=\linewidth,height=.9\textheight,keepaspectratio}
	\begin{tikzpicture}[
		every node/.style={
			align=center,
			text width=(\linewidth-1em)/2-2*\pgfkeysvalueof{/pgf/inner xsep}-2*\pgflinewidth,
			draw,
			rounded corners,
		},
		node distance=1em,
	]
	\mbrpset{#1}
	\node(top)[text width=.9\linewidth]{\textsc{\pgfkeysvalueof{/mbrp/title1}} \\ \pgfkeysvalueof{/mbrp/title2}};
	\node(a0)[narrower autopilot,draw=none,narrower left column=below top]{$\downarrow${} \textsc{Autopilot} $\downarrow$};
	\draw[autopilot arrow] (top)--(a0);
	\foreach [var=\type,var=\content,count=\curr,remember=\curr as \prev (initially 0)] in \mbrpAutopilot {
		\node(a\curr) [narrower autopilot,\type,below=of a\prev]{\content};
		\draw[autopilot arrow] (a\prev.south)--(a\curr.north);
	}


	\node(b1)[wider sober,wider right column=below top]{\soberName{Brzdi!} \pgfkeysvalueof{/mbrp/brzda B}};
	\node(b2)[wider sober,below=of b1]{\soberName{Roz-vhled!} Podívejte se bez posuzování na probíhající zkušenost: \begin{iitemize}\foreach\content in\mbrpBrzdaR{\item\content}\end{iitemize}};
	\node(b3)[wider sober,below=of b2]{\soberName{Zakotvi se!} \pgfkeysvalueof{/mbrp/brzda Z}};
	\node(b4)[wider sober,below=of b3]{\soberName{Doširoka se otevři!} \pgfkeysvalueof{/mbrp/brzda D}};
	\node(b5)[wider sober,below=of b4]{\soberName{Akce!} Jednejte z porozumění situaci, které máte. \begin{iitemize}\foreach\content in\mbrpBrzdaA{\item\content}\end{iitemize}};
	\begin{scope}
		\draw[sober arrow] (top) -- (b1);
		\draw[sober arrow] (b1) -- (b2);
		\draw[sober arrow] (b2) -- (b3);
		\draw[sober arrow] (b3) -- (b4);
		\draw[sober arrow] (b4) -- (b5);
	\end{scope}
	\end{tikzpicture}
	\end{adjustbox}
}

\newcommand{\soberSpaceEmpty}[1]{
	\begin{adjustbox}{width=\linewidth,height=.85\textheight,keepaspectratio}
	\mbrpset{#1}
	\def\miniStrut{\rule[-.4ex]{0pt}{0pt}}
	\def\myslenkyPocityJednani{\leavevmode\lower.3ex\hbox{\vbox{\tiny\baselineskip=0pt\lineskip=-.3ex\hbox{myšlenky}\hbox{pocity}\hbox{jednání}}}}
	\def\teloPocityMysl{\leavevmode\lower.3ex\hbox{\vbox{\tiny\baselineskip=0pt\lineskip=-.3ex\hbox{tělo\miniStrut}\hbox{pocity\miniStrut}\hbox{mysl\miniStrut}}}}
	\begin{tikzpicture}[
		every node/.style={
			align=center,
			text width=(\linewidth-1em)/2-2*\pgfkeysvalueof{/pgf/inner xsep}-2*\pgflinewidth,
			draw,
			rounded corners,
			font=\small
		},
		node distance=1em,
	]
	\node(top)[text width=.9\linewidth]{\textsc{\pgfkeysvalueof{/mbrp/title1}} \\ \rule{0em}{5ex}\Blank{1}};
	\node(a0)[autopilot,draw=none,left column=below top]{$\downarrow${} \textsc{Autopilot} $\downarrow$};
	\draw[autopilot arrow] (top)--(a0);
	\foreach [var=\curr,remember=\curr as \prev (initially 0)] in {1,2,3,4,5} {
		\node(a\curr) [autopilot,below=of a\prev]{{\LARGE \curr.} \myslenkyPocityJednani: \Blank{3}};
		\draw[autopilot arrow] (a\prev.south)--(a\curr.north);
	}


	\node(b1)[sober,right column=below top]{\soberName{Brzdi!} \Blank{1}};
	% \node(b2)[sober,below=of b1]{\soberName{Roz-vhled!} tělo\Blank{2}\linebreak pocity\Blank{2}\linebreak mysl\Blank{2}};
	\node(b2)[sober,below=of b1]{\soberName{Roz-vhled!} \teloPocityMysl: \Blank{3}};
	\node(b3)[sober,below=of b2]{\soberName{Zakotvi se!} \Blank{1}};
	%\node(b4)[sober,below=of b3]{\soberName{Doširoka se otevři!}  tělo\Blank{2}\linebreak pocity\Blank{2}\linebreak mysl\Blank{2}};
	\node(b4)[sober,below=of b3]{\soberName{Doširoka se otevři!} \teloPocityMysl: \Blank{3}};
	\node(b5)[sober,below=of b4]{\soberName{Akce!} \Blank{4}};

	\begin{scope}
		\draw[sober arrow] (top) -- (b1);
		\draw[sober arrow] (b1) -- (b2);
		\draw[sober arrow] (b2) -- (b3);
		\draw[sober arrow] (b3) -- (b4);
		\draw[sober arrow] (b4) -- (b5);
	\end{scope}
	\end{tikzpicture}
	\end{adjustbox}
}



\tikzset{
  disable rounded corners for decorations/.style={
    /pgf/every decoration/.style={
      /tikz/sharp corners
    },
  }
}

\tikzset{>=latex}


\ifplastex\else
	\clubpenalty=10000
	\widowpenalty=10000
	\usepackage{fancyhdr}
	\setlength{\headheight}{24pt}

	\pagestyle{fancy}
	\fancyfoot{}
	\fancyfoot[RO]{Prevence relapsu všímavostí -- MBRP}
	\fancyfoot[LO]{2022}
	\fancyfoot[LE]{překlad \lessstressLogo{}}
	\fancyfoot[RE]{\href{https://practicembrp.com}{PracticeMBRP.com}}
	\fancyhead{}
	\fancyhead[LE,RO]{\thepage}
	\fancyhead[LO]{\leftmark}
	\renewcommand{\sectionmark}[1]{\markboth{\arabic{section}. #1{}}{}}
	\renewcommand{\footrulewidth}{.2pt}
	\renewcommand{\headrulewidth}{.1pt}


	\fancypagestyle{start-session}{
		\fancyhf{}
		\fancyfoot[RO]{Prevence relapsu všímavostí --- MBRP}
		\fancyfoot[LO]{2022}
		\fancyhead[RO]{\thepage}
		\renewcommand{\footrulewidth}{.2pt}
		%\renewcommand{\headrulewidth}{0pt}
		\renewcommand{\headrule}{\vbox to0pt{\smash{\hbox to \headwidth{\hss\rule{10mm}{.2pt}}}}}
	}
	\usepackage{setspace}
	\setstretch{1.05}

	\usepackage{emptypage}
	\usepackage{tocloft}

	\usepackage[most]{tcolorbox}
	\newtcolorbox{session-summary}[2][]{%
		enhanced,
		boxsep=3pt,
		arc=1.25ex,
		colback=white,
		colframe=brown,
		boxrule=3pt,
		leftrule=18pt,
		parbox=false,
		overlay unbroken and first ={%
			\node[rotate=90,
						minimum width=1cm,
						anchor=south,
						font=\Large\sffamily\bfseries,
						yshift=-18pt,
						white]
			at (frame.west) {#2};
		}
	}

\fi



\ifplastex
	\newenvironment{itemize*}{\begin{itemize}}{\end{itemize}}
	\newenvironment{enumerate*}{\begin{enumerate}}{\end{enumerate}}
	\newenvironment{description*}{\begin{description}}{\end{description}}
	\newenvironment{tcolorbox}[1]{}{}
\else
	\newlist{itemize*}{itemize}{1}
	\setlist[itemize*]{label=\bullet,noitemsep,nosep,leftmargin=*}
	\newlist{enumerate*}{enumerate}{1}
	\setlist[enumerate*]{label=\arabic*.,noitemsep,nosep,leftmargin=*}
	\newlist{description*}{description}{1}
	\setlist[description*]{style=unboxed,
		%itemsep=0pt plus5em,parsep=0pt plus5em}
		% itemsep=.5em,nosep}
		noitemsep,nosep}
\fi
%\newlist{action}{enumerate}{1}
%\setlist[action]{noitemsep,nosep,label=\arabic*.} % ,leftmargin=*




%\usepackage{draftwatermark}
%\SetWatermarkText{Draft}
%\SetWatermarkScale{2}

\def\mbrpIcon#1{\includegraphics[width=1.5em]{fig/#1.pdf}}

\def\itemStop#1#2{\item[\lower.3em\hbox{\textbf{\textsf{\huge#1}}}\kern.4em] \textbf{#2} \hskip1em}

\def\itemSq{\item[\lower.1ex\hbox{\footnotesize\Square}]}

\ifplastex
	\def\normalPencilLeftDown{{\Large 🖉}}
	\def\lightning{🗲}
	\newenvironment{adjustbox}[1]{}{}
\else
	\usepackage{wasysym}
	\let\Square\undefined
	\usepackage{bbding}
	\def\normalPencilLeftDown{\texorpdfstring{\lower.2ex\hbox{\textmd{\PencilLeftDown}}}{}}
\fi

\parskip=.5\baselineskip
\parindent=0pt

\title{\ifplastex\else\vskip-2cm\fi Prevence relapsu všímavostí\\ MBRP-RA \\ pracovní listy}
\date{2022, draft}
\author{Václav Šmilauer, \lessstressLogo}

\begin{document}
	\maketitle

	%\begin{abstract}
	\subsection*{Úvodní poznámka}
		Mindfulness-Based Relapse Prevention — Rolling Admission (MBRP-RA) je protokol pro administraci MBRP programu při průběžné účasti. Protkol je podrobně popsaný v knize C. Ross \& al: \emph{Mindfulness-Based Relapse Prevention — Rolling Admission (MBRP-RA)}. Kniha je open-access, link ke stažení je na stránce \href{https://mindfulrp.com/for-clinicians}{MBRP Clinician Training and Resources} (na \url{https://mindfulrp.com}).

		Následující strany jsou překladem handoutů ze str. 105–160. Účastníci by měli na každém sezení příslušné handouty obdržet. Prvoúčastníci by měli navíc obdržet celý „Startovací balíček“ pro základní orientaci.

		Doprovodem handoutů jsou nahrávky cvičení z~\href{https://practicembrp.com}{PracticeMBRP.com}, které jsou [budou] k dispozici na \href{https://lessstress.cz}{lessstress.cz}.
	% \end{abstract}

	\setlength{\cftbeforesecskip}{1ex}

	\clearpage
	\tableofcontents
	%\end{spacing}
	\include{mbrp-handouts-content}
\end{document}
